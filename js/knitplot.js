// Generated by CoffeeScript 1.3.3
(function() {
  var Chart, ChartEditView, ChartGraphicView, ChartListView, ChartParser, ChartTextView, ConfirmationView, ErrorView, Graphic, Knitplot, Library, LogInView, LoggedInView, LoggedOutView, NeedToSignUpView, NotificationView, ParseErrorsView, Router, SVGPreviewView, SignUpView, SuccessView, containsPoint, drawCircle, drawLine, drawPolygon, drawRectangle, drawShape, drawSpline, scaleAndTranslate, scaleAndTranslatePoint, selectedColor,
    __bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; },
    __hasProp = {}.hasOwnProperty,
    __extends = function(child, parent) { for (var key in parent) { if (__hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; };

  Library = {
    "a": {
      graphic: [
        {
          rectangle: {
            topLeft: [0.00, 0.00],
            width: 1.00,
            height: 1.00
          },
          style: {
            fill: "#40e0d0",
            stroke: "#000000",
            "stroke-width": 1
          }
        }
      ]
    },
    "bp": {
      graphic: [
        {
          rectangle: {
            topLeft: [0.00, 0.00],
            width: 1.00,
            height: 1.00
          },
          style: {
            fill: "#bebebe",
            stroke: "#000000",
            "stroke-width": 1
          }
        }, {
          circle: {
            center: [0.50, 0.50],
            radius: 0.30
          },
          style: {
            fill: "#000000",
            stroke: "#000000",
            "stroke-width": 1
          }
        }
      ]
    },
    "ap": {
      graphic: [
        {
          rectangle: {
            topLeft: [0.00, 0.00],
            width: 1.00,
            height: 1.00
          },
          style: {
            fill: "#40e0d0",
            stroke: "#000000",
            "stroke-width": 1
          }
        }, {
          circle: {
            center: [0.50, 0.50],
            radius: 0.30
          },
          style: {
            fill: "#000000",
            stroke: "#000000",
            "stroke-width": 1
          }
        }
      ]
    },
    "error": {
      graphic: [
        {
          rectangle: {
            topLeft: [0.00, 0.00],
            width: 1.00,
            height: 1.00
          },
          style: {
            fill: "#ff0000",
            stroke: "#ff0000",
            "stroke-width": 1
          }
        }
      ]
    },
    "k": {
      graphic: [
        {
          rectangle: {
            topLeft: [0.00, 0.00],
            width: 1.00,
            height: 1.00
          },
          style: {
            fill: "#ffffff",
            stroke: "#000000",
            "stroke-width": 1
          }
        }
      ]
    },
    "p": {
      graphic: [
        {
          rectangle: {
            topLeft: [0.00, 0.00],
            width: 1.00,
            height: 1.00
          },
          style: {
            fill: "#808080",
            stroke: "#000000",
            "stroke-width": 1
          }
        }
      ]
    },
    "ns": {
      graphic: [
        {
          rectangle: {
            topLeft: [0.00, 0.00],
            width: 1.00,
            height: 1.00
          },
          style: {
            fill: "#000000",
            stroke: "#000000",
            "stroke-width": 1
          }
        }
      ]
    },
    "k3tog": {
      graphic: [
        {
          rectangle: {
            topLeft: [0.00, 0.00],
            width: 1.00,
            height: 1.00
          },
          style: {
            fill: "#ffffff",
            stroke: "#000000",
            "stroke-width": 1
          }
        }, {
          line: {
            point1: [0.20, 0.80],
            point2: [0.80, 0.20]
          },
          style: {
            fill: "#000000",
            stroke: "#000000",
            "stroke-width": 1
          }
        }, {
          line: {
            point1: [0.50, 0.50],
            point2: [0.50, 0.80]
          },
          style: {
            fill: "#000000",
            stroke: "#000000",
            "stroke-width": 1
          }
        }
      ]
    },
    "k2tog": {
      graphic: [
        {
          rectangle: {
            topLeft: [0.00, 0.00],
            width: 1.00,
            height: 1.00
          },
          style: {
            fill: "#ffffff",
            stroke: "#000000",
            "stroke-width": 1
          }
        }, {
          line: {
            point1: [0.20, 0.80],
            point2: [0.80, 0.20]
          },
          style: {
            fill: "#000000",
            stroke: "#000000",
            "stroke-width": 1
          }
        }
      ]
    },
    "sk2p": {
      graphic: [
        {
          rectangle: {
            topLeft: [0.00, 0.00],
            width: 1.00,
            height: 1.00
          },
          style: {
            fill: "#ffffff",
            stroke: "#000000",
            "stroke-width": 1
          }
        }, {
          line: {
            point1: [0.20, 0.20],
            point2: [0.80, 0.80]
          },
          style: {
            fill: "#000000",
            stroke: "#000000",
            "stroke-width": 1
          }
        }, {
          line: {
            point1: [0.50, 0.50],
            point2: [0.50, 0.80]
          },
          style: {
            fill: "#000000",
            stroke: "#000000",
            "stroke-width": 1
          }
        }
      ]
    },
    "ssk": {
      graphic: [
        {
          rectangle: {
            topLeft: [0.00, 0.00],
            width: 1.00,
            height: 1.00
          },
          style: {
            fill: "#ffffff",
            stroke: "#000000",
            "stroke-width": 1
          }
        }, {
          line: {
            point1: [0.20, 0.20],
            point2: [0.80, 0.80]
          },
          style: {
            fill: "#000000",
            stroke: "#000000",
            "stroke-width": 1
          }
        }
      ]
    },
    "cdd": {
      graphic: [
        {
          rectangle: {
            topLeft: [0.00, 0.00],
            width: 1.00,
            height: 1.00
          },
          style: {
            fill: "#ffffff",
            stroke: "#000000",
            "stroke-width": 1
          }
        }, {
          line: {
            point1: [0.50, 0.50],
            point2: [0.50, 0.80]
          },
          style: {
            fill: "#000000",
            stroke: "#000000",
            "stroke-width": 1
          }
        }, {
          line: {
            point1: [0.50, 0.50],
            point2: [0.20, 0.80]
          },
          style: {
            fill: "#000000",
            stroke: "#000000",
            "stroke-width": 1
          }
        }, {
          line: {
            point1: [0.50, 0.50],
            point2: [0.80, 0.80]
          },
          style: {
            fill: "#000000",
            stroke: "#000000",
            "stroke-width": 1
          }
        }
      ]
    },
    "yo": {
      graphic: [
        {
          rectangle: {
            topLeft: [0.00, 0.00],
            width: 1.00,
            height: 1.00
          },
          style: {
            fill: "#ffffff",
            stroke: "#000000",
            "stroke-width": 1
          }
        }, {
          circle: {
            center: [0.50, 0.50],
            radius: 0.30
          },
          style: {
            fill: "#ffffff",
            stroke: "#000000",
            "stroke-width": 1
          }
        }
      ]
    },
    "t#l": {
      graphic: [
        {
          rectangle: {
            topLeft: [0.00, 0.00],
            width: 1.00,
            height: 1.00
          },
          style: {
            fill: "#ffffff",
            stroke: "#000000",
            "stroke-width": 1
          }
        }, {
          polygon: [[0.00, 0.00], [0.00, 1.00], [0.33, 1.00]],
          style: {
            fill: "#7f7f7f",
            stroke: "#000000",
            "stroke-width": 1
          }
        }, {
          polygon: [[1.00, 0.00], [0.67, 0.00], [1.00, 1.00]],
          style: {
            fill: "#7f7f7f",
            stroke: "#000000",
            "stroke-width": 1
          }
        }
      ]
    },
    "t#r": {
      graphic: [
        {
          rectangle: {
            topLeft: [0.00, 0.00],
            width: 1.00,
            height: 1.00
          },
          style: {
            fill: "#ffffff",
            stroke: "#000000",
            "stroke-width": 1
          }
        }, {
          polygon: [[0.00, 0.00], [0.00, 1.00], [0.33, 1.00]],
          style: {
            fill: "#7f7f7f",
            stroke: "#000000",
            "stroke-width": 1
          }
        }, {
          polygon: [[1.00, 0.00], [0.67, 1.00], [1.00, 1.00]],
          style: {
            fill: "#7f7f7f",
            stroke: "#000000",
            "stroke-width": 1
          }
        }
      ]
    },
    "c#l": {
      graphic: [
        {
          rectangle: {
            topLeft: [0.00, 0.00],
            width: 1.00,
            height: 1.00
          },
          style: {
            fill: "#ffffff",
            stroke: "#000000",
            "stroke-width": 1
          }
        }, {
          line: {
            point1: [0.00, 0.00],
            point2: [0.50, 1.00]
          },
          style: {
            fill: "#000000",
            stroke: "#000000",
            "stroke-width": 1
          }
        }, {
          line: {
            point1: [0.50, 0.00],
            point2: [1.00, 1.00]
          },
          style: {
            fill: "#000000",
            stroke: "#000000",
            "stroke-width": 1
          }
        }
      ]
    },
    "c#r": {
      graphic: [
        {
          rectangle: {
            topLeft: [0.00, 0.00],
            width: 1.00,
            height: 1.00
          },
          style: {
            fill: "#ffffff",
            stroke: "#000000",
            "stroke-width": 1
          }
        }, {
          line: {
            point1: [0.00, 1.00],
            point2: [0.50, 0.00]
          },
          style: {
            fill: "#000000",
            stroke: "#000000",
            "stroke-width": 1
          }
        }, {
          line: {
            point1: [0.50, 1.00],
            point2: [1.00, 0.00]
          },
          style: {
            fill: "#000000",
            stroke: "#000000",
            "stroke-width": 1
          }
        }
      ]
    },
    "b": {
      graphic: [
        {
          rectangle: {
            topLeft: [0.00, 0.00],
            width: 1.00,
            height: 1.00
          },
          style: {
            fill: "#ffffff",
            stroke: "#000000",
            "stroke-width": 1
          }
        }, {
          spline: [[0.30, 0.80], [0.70, 0.40], [0.50, 0.10], [0.30, 0.40], [0.70, 0.80]],
          style: {
            fill: "#ffffff",
            stroke: "#000000",
            "stroke-width": 1
          }
        }
      ]
    },
    "tssk": {
      graphic: [
        {
          rectangle: {
            topLeft: [0.00, 0.00],
            width: 1.00,
            height: 1.00
          },
          style: {
            fill: "#ffffff",
            stroke: "#000000",
            "stroke-width": 1
          }
        }, {
          line: {
            point1: [0.10, 0.80],
            point2: [0.50, 0.20]
          },
          style: {
            fill: "#ffffff",
            stroke: "#000000",
            "stroke-width": 1
          }
        }, {
          spline: [[0.60, 0.80], [0.90, 0.40], [0.75, 0.10], [0.60, 0.40], [0.90, 0.80]],
          style: {
            fill: "#ffffff",
            stroke: "#000000",
            "stroke-width": 1
          }
        }
      ]
    },
    "k2togtbl": {
      graphic: [
        {
          rectangle: {
            topLeft: [0.00, 0.00],
            width: 1.00,
            height: 1.00
          },
          style: {
            fill: "#ffffff",
            stroke: "#000000",
            "stroke-width": 1
          }
        }, {
          line: {
            point1: [0.90, 0.80],
            point2: [0.50, 0.20]
          },
          style: {
            fill: "#ffffff",
            stroke: "#000000",
            "stroke-width": 1
          }
        }, {
          spline: [[0.10, 0.80], [0.40, 0.40], [0.25, 0.10], [0.10, 0.40], [0.40, 0.80]],
          style: {
            fill: "#ffffff",
            stroke: "#000000",
            "stroke-width": 1
          }
        }
      ]
    },
    "p2togtbl": {
      graphic: [
        {
          rectangle: {
            topLeft: [0.00, 0.00],
            width: 1.00,
            height: 1.00
          },
          style: {
            fill: "#ffffff",
            stroke: "#000000",
            "stroke-width": 1
          }
        }, {
          line: {
            point1: [0.20, 0.60],
            point2: [0.40, 0.60]
          },
          style: {
            fill: "#000000",
            stroke: "#000000",
            "stroke-width": 1
          }
        }, {
          line: {
            point1: [0.20, 0.20],
            point2: [0.80, 0.80]
          },
          style: {
            fill: "#000000",
            stroke: "#000000",
            "stroke-width": 1
          }
        }
      ]
    },
    "p2tog": {
      graphic: [
        {
          rectangle: {
            topLeft: [0.00, 0.00],
            width: 1.00,
            height: 1.00
          },
          style: {
            fill: "#ffffff",
            stroke: "#000000",
            "stroke-width": 1
          }
        }, {
          line: {
            point1: [0.60, 0.60],
            point2: [0.80, 0.60]
          },
          style: {
            fill: "#000000",
            stroke: "#000000",
            "stroke-width": 1
          }
        }, {
          line: {
            point1: [0.20, 0.80],
            point2: [0.80, 0.20]
          },
          style: {
            fill: "#000000",
            stroke: "#000000",
            "stroke-width": 1
          }
        }
      ]
    },
    "mil": {
      graphic: [
        {
          rectangle: {
            topLeft: [0.00, 0.00],
            width: 1.00,
            height: 1.00
          },
          style: {
            fill: "#ffffff",
            stroke: "#000000",
            "stroke-width": 1
          }
        }, {
          line: {
            point1: [0.20, 0.80],
            point2: [0.50, 0.20]
          },
          style: {
            fill: "#000000",
            stroke: "#000000",
            "stroke-width": 1
          }
        }, {
          line: {
            point1: [0.50, 0.20],
            point2: [0.80, 0.80]
          },
          style: {
            fill: "#000000",
            stroke: "#000000",
            "stroke-width": 1
          }
        }
      ]
    }
  };

  Router = (function(_super) {

    __extends(Router, _super);

    function Router() {
      this.listCharts = __bind(this.listCharts, this);

      this.editChart = __bind(this.editChart, this);

      this.newChart = __bind(this.newChart, this);
      return Router.__super__.constructor.apply(this, arguments);
    }

    Router.prototype.routes = {
      "": "newChart",
      "new": "newChart",
      "new/:start": "newChart",
      "chart/:id": "editChart",
      "chart/:id/:start": "editChart",
      "charts/:start": "listCharts"
    };

    Router.prototype.newChart = function(start) {
      return knitplot.confirmUnload({
        yes: function() {
          return knitplot.newChart(start);
        },
        no: function() {
          return knitplot.fixHistory();
        }
      });
    };

    Router.prototype.editChart = function(id, start) {
      return knitplot.confirmUnload({
        yes: function() {
          return knitplot.editChart(id, start);
        },
        no: function() {
          return knitplot.fixHistory();
        }
      });
    };

    Router.prototype.listCharts = function(start) {
      if (start == null) {
        start = 0;
      }
      return knitplot.listCharts(start);
    };

    return Router;

  })(Backbone.Router);

  Knitplot = (function() {

    function Knitplot() {
      this.confirmUnloadMessage = __bind(this.confirmUnloadMessage, this);

      this.confirmUnload = __bind(this.confirmUnload, this);

      this.fixHistory = __bind(this.fixHistory, this);

      this.showUser = __bind(this.showUser, this);

      this.listCharts = __bind(this.listCharts, this);

      this.saveChart = __bind(this.saveChart, this);

      this.editChart = __bind(this.editChart, this);

      this.newChart = __bind(this.newChart, this);

      this.init = __bind(this.init, this);

    }

    Knitplot.prototype.init = function() {
      this.start = 0;
      this.chart = new Chart();
      Parse.initialize("732uFxOqiBozGHcv6BUyEZrpQC0oIbmTbi4UJuK2", "JB48tpHfZ39NTwrRuQIoqq7GQzpdxLonrjpsj67L");
      new Router();
      Backbone.history.start();
      return $(window).bind('beforeunload', this.confirmUnloadMessage);
    };

    Knitplot.prototype.newChart = function(start) {
      this.chart = new Chart({
        title: "Untitled",
        text: "k2,p3\nyo4,k2tog"
      });
      if (start) {
        this.start = start;
      }
      this.listCharts(this.start);
      this.showUser();
      new ChartEditView({
        model: this.chart
      });
      return this.fixHistory();
    };

    Knitplot.prototype.editChart = function(id, start) {
      var _this = this;
      if (id === "new") {
        return this.newChart(start);
      }
      this.chart = new Chart({
        objectId: id
      });
      if (start) {
        this.start = start;
      }
      this.chart.fetch({
        success: function() {
          return new ChartEditView({
            model: _this.chart
          });
        },
        error: function(chart, error) {
          new ErrorView({
            message: "Unable to load chart."
          });
          return window.location.hash = "#";
        }
      });
      this.listCharts(this.start);
      return this.showUser();
    };

    Knitplot.prototype.saveChart = function() {
      var _this = this;
      if (!knitplot.chart.get("creator")) {
        knitplot.chart.set("creator", Parse.User.current());
      }
      return knitplot.chart.save({
        success: function() {
          new SuccessView({
            message: "Saved!"
          });
          _this.listCharts(0);
          return _this.fixHistory();
        },
        error: function() {
          return new ErrorView({
            message: "Unable to save."
          });
        }
      });
    };

    Knitplot.prototype.listCharts = function(start) {
      var charts, query,
        _this = this;
      if (start == null) {
        start = 0;
      }
      this.start = start;
      query = new Parse.Query(Chart);
      query.equalTo("creator", Parse.User.current());
      query.descending("updatedAt", "createdAt").skip(start).limit(11);
      charts = query.collection();
      charts.fetch({
        success: function() {
          return new ChartListView({
            collection: charts,
            start: parseInt(start)
          });
        },
        error: function(charts, error) {
          return new ErrorView({
            message: "Unable to load chart list."
          });
        }
      });
      return this.fixHistory();
    };

    Knitplot.prototype.showUser = function() {
      if (Parse.User.current()) {
        return new LoggedInView();
      } else {
        return new LoggedOutView();
      }
    };

    Knitplot.prototype.fixHistory = function() {
      if (this.chart.isNew()) {
        return Backbone.history.navigate("#chart/new/" + this.start, {
          replace: true
        });
      } else {
        return Backbone.history.navigate("#chart/" + this.chart.id + "/" + this.start, {
          replace: true
        });
      }
    };

    Knitplot.prototype.confirmUnload = function(options) {
      var message;
      message = this.confirmUnloadMessage();
      if (message) {
        return new ConfirmationView({
          message: "Are you sure you want to leave this page?\n\n" + message,
          yes: options.yes,
          no: options.no
        });
      } else {
        if (options.yes) {
          return options.yes();
        }
      }
    };

    Knitplot.prototype.confirmUnloadMessage = function() {
      if (this.chart.dirty("text") || this.chart.dirty("title")) {
        return "Your chart has not been saved.";
      }
    };

    return Knitplot;

  })();

  window.knitplot = new Knitplot();

  Chart = (function(_super) {

    __extends(Chart, _super);

    function Chart() {
      return Chart.__super__.constructor.apply(this, arguments);
    }

    Chart.prototype.className = "Chart";

    return Chart;

  })(Parse.Object);

  ChartParser = (function(_super) {

    __extends(ChartParser, _super);

    function ChartParser() {
      this._parseChart = __bind(this._parseChart, this);

      this._parseRow = __bind(this._parseRow, this);

      this._parseAction = __bind(this._parseAction, this);

      this._eatWhitespace = __bind(this._eatWhitespace, this);

      this._addMessage = __bind(this._addMessage, this);

      this.parse = __bind(this.parse, this);
      return ChartParser.__super__.constructor.apply(this, arguments);
    }

    ChartParser.prototype.parse = function(text) {
      var chart;
      this.text = text;
      this.line = 0;
      this.lineStart = 0;
      this.tokenLength = 1;
      this.offset = 0;
      this.warnings = [];
      this.errors = [];
      chart = this._parseChart();
      this.set({
        chart: chart,
        errors: this.errors,
        warnings: this.warnings
      });
      return this.attributes;
    };

    ChartParser.prototype._addMessage = function(list, message) {
      return list.push({
        message: message,
        offset: this.offset - this.tokenLength,
        line: this.line + 1,
        column: ((this.offset - this.tokenLength) - this.lineStart) + 1,
        length: this.tokenLength
      });
    };

    ChartParser.prototype._eatWhitespace = function() {
      var _results;
      this.tokenLength = 0;
      _results = [];
      while (this.text[this.offset] && /[ \t\r]/.test(this.text[this.offset])) {
        _results.push(this.offset++);
      }
      return _results;
    };

    ChartParser.prototype._parseAction = function() {
      var action, altText, defaults, found, match, number, prefix, start, suffix, text, _ref, _ref1;
      this._eatWhitespace();
      start = this.offset;
      this.tokenLength = 0;
      while (this.text[this.offset] && !/[, \t\r\n]/.test(this.text[this.offset])) {
        ++this.offset;
        ++this.tokenLength;
      }
      if (this.tokenLength === 0) {
        if ((!this.text[this.offset]) || /\r\n/.test(this.text[this.offset])) {
          return null;
        } else {
          this._addMessage(this.warnings, "Missing action.");
          return null;
        }
      }
      text = this.text.slice(start, start + this.tokenLength);
      action = {
        action: text,
        width: 1,
        textRow: this.line,
        textColumn: (this.offset - this.tokenLength) - this.lineStart,
        textOffset: this.offset - this.tokenLength,
        textLength: this.tokenLength
      };
      _ref = /^(.*[^0-9])([0-9]*)$/.exec(text), match = _ref[0], text = _ref[1], number = _ref[2];
      action.action = text;
      if (number) {
        action.repetitions = parseInt(number);
      }
      defaults = {
        width: 1,
        repetitions: 1
      };
      found = false;
      if (Library[text]) {
        action = _.extend(defaults, Library[text], action);
        found = true;
      } else {
        match = /^([^0-9]*)([0-9]*)([^0-9]*)$/.exec(text);
        if (match) {
          _ref1 = match, match = _ref1[0], prefix = _ref1[1], number = _ref1[2], suffix = _ref1[3];
          altText = "" + prefix + "#" + suffix;
          if (match && Library[altText]) {
            action = _.extend(defaults, Library[altText], action);
            action.action = altText;
            action.width = action.width * parseInt(number);
            found = true;
          }
        }
      }
      if (!found) {
        this._addMessage(this.errors, "Unknown action type: \"" + text + "\".");
        action = _.extend(defaults, Library.error, action, {
          action: "error"
        });
      }
      return action;
    };

    ChartParser.prototype._parseRow = function() {
      var action, row, start, token;
      row = [];
      this._eatWhitespace();
      if ((!this.text[this.offset]) || this.text[this.offset] === "\n") {
        return row;
      }
      action = this._parseAction();
      if (action) {
        row.push(action);
      }
      this._eatWhitespace();
      while (!((!this.text[this.offset]) || this.text[this.offset] === "\n")) {
        if (this.text[this.offset] === ",") {
          ++this.offset;
          action = this._parseAction();
          if (action) {
            row.push(action);
          }
          this._eatWhitespace();
        } else {
          start = this.offset;
          while (!((!this.text[this.offset]) || /[, \t\r\n]/.test(this.text[this.offset]))) {
            ++this.offset;
            ++this.tokenLength;
          }
          token = this.text.slice(start, start + this.tokenLength);
          this._addMessage(this.errors, "Stray text: \"" + token + "\".");
          this._eatWhitespace();
        }
      }
      return row;
    };

    ChartParser.prototype._parseChart = function() {
      var chart;
      this._eatWhitespace();
      chart = [];
      while (this.text[this.offset] && this.text[this.offset] === "\n") {
        ++this.offset;
        this._eatWhitespace();
      }
      if (!this.text[this.offset]) {
        return chart;
      }
      chart.push(this._parseRow());
      this._eatWhitespace();
      while (this.text[this.offset]) {
        if (this.text[this.offset] === "\n") {
          ++this.offset;
          ++this.line;
          this.lineStart = this.offset;
          this._eatWhitespace();
          if (!this.text[this.offset]) {
            return chart;
          }
          chart.push(this._parseRow());
          this._eatWhitespace();
        } else {
          this._addMessage(this.errors, "Stray text after row.");
          ++this.offset;
        }
      }
      return chart;
    };

    return ChartParser;

  })(Backbone.Model);

  window.ChartParser = ChartParser;

  drawLine = function(canvas, shape) {
    var line, path;
    path = ("M" + shape.line.point1[0] + "," + shape.line.point1[1]) + ("L" + shape.line.point2[0] + "," + shape.line.point2[1]);
    line = canvas.path(path);
    return line.attr(shape.style);
  };

  drawRectangle = function(canvas, shape) {
    var rect;
    rect = canvas.rect(shape.rectangle.topLeft[0], shape.rectangle.topLeft[1], shape.rectangle.width, shape.rectangle.height);
    return rect.attr(shape.style);
  };

  drawCircle = function(canvas, shape) {
    var circle;
    circle = canvas.circle(shape.circle.center[0], shape.circle.center[1], shape.circle.radius);
    return circle.attr(shape.style);
  };

  drawPolygon = function(canvas, shape) {
    var path, point, polygon;
    path = ("M" + shape.polygon[0][0] + "," + shape.polygon[0][1]) + ((function() {
      var _i, _len, _ref, _results;
      _ref = shape.polygon.slice(1);
      _results = [];
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        point = _ref[_i];
        _results.push("L" + point[0] + "," + point[1]);
      }
      return _results;
    })()).join("");
    polygon = canvas.path(path);
    return polygon.attr(shape.style);
  };

  drawSpline = function(canvas, shape) {
    var c, current, next, path, spline;
    current = shape.spline[0];
    next = shape.spline[1];
    c = [(current[0] + next[0]) / 2, (current[1] + next[1]) / 2];
    path = "M" + current[0] + "," + current[1] + "L" + c[0] + "," + c[1];
    _.each(shape.spline.slice(2), function(point) {
      current = next;
      next = point;
      c = [(current[0] + next[0]) / 2, (current[1] + next[1]) / 2];
      return path = "" + path + " Q" + current[0] + "," + current[1] + " " + c[0] + "," + c[1];
    });
    path = "" + path + " L" + next[0] + "," + next[1];
    spline = canvas.path(path);
    return spline.attr(shape.style);
  };

  selectedColor = function(color) {
    var b, g, r;
    r = Math.round(parseInt(color.substring(1, 3), 16) * 0.75);
    g = Math.round(parseInt(color.substring(3, 5), 16) * 0.75);
    b = Math.round(parseInt(color.substring(5, 7), 16) * 1.00);
    return "#" + ("0" + r.toString(16)).slice(-2) + ("0" + g.toString(16)).slice(-2) + ("0" + b.toString(16)).slice(-2);
  };

  drawShape = function(canvas, shape, selection) {
    var selected;
    selected = selection && ((shape.action.textRow > selection.start.row) || ((shape.action.textRow === selection.start.row) && (shape.action.textColumn >= selection.start.column))) && ((shape.action.textRow < selection.end.row) || ((shape.action.textRow === selection.end.row) && (shape.action.textColumn <= selection.end.column)));
    if (selected) {
      shape = _.clone(shape);
      shape.style = _.clone(shape.style);
      shape.style.fill = selectedColor(shape.style.fill);
    }
    if (shape.line) {
      return drawLine(canvas, shape);
    } else if (shape.rectangle) {
      return drawRectangle(canvas, shape);
    } else if (shape.circle) {
      return drawCircle(canvas, shape);
    } else if (shape.polygon) {
      return drawPolygon(canvas, shape);
    } else if (shape.spline) {
      return drawSpline(canvas, shape);
    } else {
      return console.warn(shape);
    }
  };

  containsPoint = function(shape, x, y) {
    var bottom, left, right, top;
    if (shape.rectangle) {
      left = shape.rectangle.topLeft[0];
      top = shape.rectangle.topLeft[1];
      right = left + shape.rectangle.width;
      bottom = top + shape.rectangle.height;
      if ((left <= x && x < right) && (top <= y && y < bottom)) {
        return true;
      }
    }
    return false;
  };

  scaleAndTranslatePoint = function(point, x, y, width, height) {
    return [point[0] * width + x, point[1] * height + y];
  };

  scaleAndTranslate = function(shape, x, y, width, height) {
    var point;
    if (shape.line) {
      return {
        line: {
          point1: scaleAndTranslatePoint(shape.line.point1, x, y, width, height),
          point2: scaleAndTranslatePoint(shape.line.point2, x, y, width, height)
        },
        style: shape.style
      };
    } else if (shape.rectangle) {
      return {
        rectangle: {
          topLeft: scaleAndTranslatePoint(shape.rectangle.topLeft, x, y, width, height),
          width: shape.rectangle.width * width,
          height: shape.rectangle.height * height
        },
        style: shape.style
      };
    } else if (shape.circle) {
      return {
        circle: {
          center: scaleAndTranslatePoint(shape.circle.center, x, y, width, height),
          radius: Math.min(shape.circle.radius * width, shape.circle.radius * height)
        },
        style: shape.style
      };
    } else if (shape.polygon) {
      return {
        polygon: (function() {
          var _i, _len, _ref, _results;
          _ref = shape.polygon;
          _results = [];
          for (_i = 0, _len = _ref.length; _i < _len; _i++) {
            point = _ref[_i];
            _results.push(scaleAndTranslatePoint(point, x, y, width, height));
          }
          return _results;
        })(),
        style: shape.style
      };
    } else if (shape.spline) {
      return {
        spline: (function() {
          var _i, _len, _ref, _results;
          _ref = shape.spline;
          _results = [];
          for (_i = 0, _len = _ref.length; _i < _len; _i++) {
            point = _ref[_i];
            _results.push(scaleAndTranslatePoint(point, x, y, width, height));
          }
          return _results;
        })(),
        style: shape.style
      };
    } else {
      console.warn(shape);
      return {};
    }
  };

  Graphic = (function() {

    function Graphic(chart, maxWidth, maxHeight) {
      this.actionAtPoint = __bind(this.actionAtPoint, this);

      this._shapeAtPoint = __bind(this._shapeAtPoint, this);

      this.draw = __bind(this.draw, this);

      var action, column, columnWidth, columns, height, newShape, newShapeHeight, newShapeWidth, newShapeX, newShapeY, rep, row, rowHeight, rowIndex, rows, shape, width, _i, _j, _k, _l, _len, _len1, _len2, _len3, _len4, _m, _n, _ref, _ref1;
      maxWidth = maxWidth - 1;
      maxHeight = maxHeight - 1;
      columns = 1;
      for (_i = 0, _len = chart.length; _i < _len; _i++) {
        row = chart[_i];
        column = 0;
        for (_j = 0, _len1 = row.length; _j < _len1; _j++) {
          action = row[_j];
          column = column + (action.width * action.repetitions);
        }
        if (column > columns) {
          columns = column;
        }
      }
      rows = chart.length;
      width = maxWidth;
      columnWidth = Math.floor(width / columns);
      rowHeight = Math.floor(columnWidth * 0.75);
      height = rowHeight * rows;
      if (height > maxHeight) {
        height = maxHeight;
        rowHeight = Math.floor(height / rows);
        columnWidth = Math.floor(rowHeight / 0.75);
        width = columnWidth * columns;
      }
      this.graphic = {
        width: width,
        height: height,
        shapes: []
      };
      for (rowIndex = _k = 0, _len2 = chart.length; _k < _len2; rowIndex = ++_k) {
        row = chart[rowIndex];
        column = 0;
        for (_l = 0, _len3 = row.length; _l < _len3; _l++) {
          action = row[_l];
          for (rep = _m = 1, _ref = action.repetitions; 1 <= _ref ? _m <= _ref : _m >= _ref; rep = 1 <= _ref ? ++_m : --_m) {
            _ref1 = action.graphic;
            for (_n = 0, _len4 = _ref1.length; _n < _len4; _n++) {
              shape = _ref1[_n];
              newShapeX = 1 + (columns - (column + action.width)) * columnWidth;
              newShapeY = 1 + (rows - (rowIndex + 1)) * rowHeight;
              newShapeWidth = action.width * columnWidth;
              newShapeHeight = rowHeight;
              newShape = scaleAndTranslate(shape, newShapeX, newShapeY, newShapeWidth, newShapeHeight);
              newShape.action = action;
              this.graphic.shapes.push(newShape);
            }
            column = column + action.width;
          }
        }
      }
    }

    Graphic.prototype.draw = function(canvas, selection) {
      var shape, _i, _len, _ref, _results;
      canvas.clear();
      _ref = this.graphic.shapes;
      _results = [];
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        shape = _ref[_i];
        _results.push(drawShape(canvas, shape, selection));
      }
      return _results;
    };

    Graphic.prototype._shapeAtPoint = function(x, y) {
      var shape, _i, _len, _ref;
      _ref = this.graphic.shapes;
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        shape = _ref[_i];
        if (containsPoint(shape, x, y)) {
          return shape;
        }
      }
      return void 0;
    };

    Graphic.prototype.actionAtPoint = function(x, y) {
      var _ref;
      return (_ref = this._shapeAtPoint(x, y)) != null ? _ref.action : void 0;
    };

    return Graphic;

  })();

  NotificationView = (function(_super) {

    __extends(NotificationView, _super);

    function NotificationView() {
      this.render = __bind(this.render, this);

      this.initialize = __bind(this.initialize, this);
      return NotificationView.__super__.constructor.apply(this, arguments);
    }

    NotificationView.prototype.className = "ui-state-highlight ui-corner-all";

    NotificationView.prototype.initialize = function() {
      return this.render();
    };

    NotificationView.prototype.render = function() {
      var notification, _ref,
        _this = this;
      $(this.el).html((_ref = this.options.message) != null ? _ref : "Success!");
      notification = $("#notification");
      notification.html(this.el);
      notification.hide();
      notification.slideDown();
      $.doTimeout(3000, function() {
        notification.slideUp();
        return $.doTimeout(20000, function() {
          return notification.remove();
        });
      });
      return this.delegateEvents();
    };

    return NotificationView;

  })(Parse.View);

  ConfirmationView = (function(_super) {

    __extends(ConfirmationView, _super);

    function ConfirmationView() {
      this.no = __bind(this.no, this);

      this.yes = __bind(this.yes, this);

      this.render = __bind(this.render, this);

      this.initialize = __bind(this.initialize, this);
      return ConfirmationView.__super__.constructor.apply(this, arguments);
    }

    ConfirmationView.prototype.events = {
      "click #yes": "yes",
      "click #no": "no"
    };

    ConfirmationView.prototype.initialize = function() {
      return this.render();
    };

    ConfirmationView.prototype.render = function() {
      var template;
      template = _.template($('#confirmation-template').html());
      $(this.el).html(template({
        message: this.options.message || "Are you sure?"
      }));
      $(this.el).dialog({
        title: this.options.title || "Are you sure?",
        modal: true
      });
      $('#dialog-button-bar #no').button();
      return $('#dialog-button-bar #yes').button();
    };

    ConfirmationView.prototype.yes = function() {
      if (this.options.yes) {
        this.options.yes();
      }
      return $(this.el).remove();
    };

    ConfirmationView.prototype.no = function() {
      if (this.options.no) {
        this.options.no();
      }
      return $(this.el).remove();
    };

    return ConfirmationView;

  })(Parse.View);

  SuccessView = (function(_super) {

    __extends(SuccessView, _super);

    function SuccessView() {
      return SuccessView.__super__.constructor.apply(this, arguments);
    }

    SuccessView.prototype.className = "ui-state-highlight ui-corner-all success";

    return SuccessView;

  })(NotificationView);

  ErrorView = (function(_super) {

    __extends(ErrorView, _super);

    function ErrorView() {
      return ErrorView.__super__.constructor.apply(this, arguments);
    }

    ErrorView.prototype.className = "ui-state-error ui-corner-all error";

    return ErrorView;

  })(NotificationView);

  LoggedInView = (function(_super) {

    __extends(LoggedInView, _super);

    function LoggedInView() {
      this.logOut = __bind(this.logOut, this);

      this.render = __bind(this.render, this);

      this.initialize = __bind(this.initialize, this);
      return LoggedInView.__super__.constructor.apply(this, arguments);
    }

    LoggedInView.prototype.events = {
      "click #username": "logOut"
    };

    LoggedInView.prototype.initialize = function() {
      return this.render();
    };

    LoggedInView.prototype.render = function() {
      var template;
      template = _.template($('#logged-in-template').html());
      $(this.el).html(template({
        username: Parse.User.current().get('username')
      }));
      $('#user').html(this.el);
      $('#username').button();
      return this.delegateEvents();
    };

    LoggedInView.prototype.logOut = function() {
      Parse.User.logOut();
      return new ConfirmationView({
        message: "Are you sure you want to log out?",
        yes: function() {
          return new LoggedOutView();
        }
      });
    };

    return LoggedInView;

  })(Parse.View);

  LoggedOutView = (function(_super) {

    __extends(LoggedOutView, _super);

    function LoggedOutView() {
      this.signUp = __bind(this.signUp, this);

      this.logIn = __bind(this.logIn, this);

      this.render = __bind(this.render, this);

      this.initialize = __bind(this.initialize, this);
      return LoggedOutView.__super__.constructor.apply(this, arguments);
    }

    LoggedOutView.prototype.events = {
      "click #login": "logIn",
      "click #signup": "signUp"
    };

    LoggedOutView.prototype.initialize = function() {
      return this.render();
    };

    LoggedOutView.prototype.render = function() {
      var template;
      template = $('#logged-out-template').html();
      $(this.el).html(_.template(template)({}));
      $('#user').html(this.el);
      $('#signup').button();
      $('#login').button();
      return this.delegateEvents();
    };

    LoggedOutView.prototype.logIn = function() {
      return new LogInView();
    };

    LoggedOutView.prototype.signUp = function() {
      return new SignUpView();
    };

    return LoggedOutView;

  })(Parse.View);

  LogInView = (function(_super) {

    __extends(LogInView, _super);

    function LogInView() {
      this.cancel = __bind(this.cancel, this);

      this.logIn = __bind(this.logIn, this);

      this.render = __bind(this.render, this);

      this.initialize = __bind(this.initialize, this);
      return LogInView.__super__.constructor.apply(this, arguments);
    }

    LogInView.prototype.events = {
      "click #login": "logIn",
      "click #cancel": "cancel"
    };

    LogInView.prototype.initialize = function() {
      return this.render();
    };

    LogInView.prototype.render = function() {
      var template;
      template = $('#login-template').html();
      $(this.el).html(template);
      $(this.el).dialog({
        title: "Log in to Knitplot!",
        modal: true
      });
      $('#dialog-button-bar #cancel').button();
      return $('#dialog-button-bar #login').button();
    };

    LogInView.prototype.logIn = function() {
      var _this = this;
      return Parse.User.logIn($('#email').val(), $('#password').val(), {
        success: function() {
          $(_this.el).remove();
          return new LoggedInView();
        },
        error: function(user, error) {
          return alert(error.message);
        }
      });
    };

    LogInView.prototype.cancel = function() {
      return $(this.el).remove();
    };

    return LogInView;

  })(Parse.View);

  NeedToSignUpView = (function(_super) {

    __extends(NeedToSignUpView, _super);

    function NeedToSignUpView() {
      this.okay = __bind(this.okay, this);

      this.render = __bind(this.render, this);

      this.initialize = __bind(this.initialize, this);
      return NeedToSignUpView.__super__.constructor.apply(this, arguments);
    }

    NeedToSignUpView.prototype.events = {
      "click #okay": "okay"
    };

    NeedToSignUpView.prototype.initialize = function() {
      return this.render();
    };

    NeedToSignUpView.prototype.render = function() {
      var template;
      template = $('#need-to-sign-up-template').html();
      $(this.el).html(template);
      $(this.el).dialog({
        title: "Sign up for Knitplot!",
        modal: true
      });
      return $('#dialog-button-bar #okay').button();
    };

    NeedToSignUpView.prototype.okay = function() {
      return $(this.el).remove();
    };

    return NeedToSignUpView;

  })(Parse.View);

  SignUpView = (function(_super) {

    __extends(SignUpView, _super);

    function SignUpView() {
      this.cancel = __bind(this.cancel, this);

      this.signup = __bind(this.signup, this);

      this.render = __bind(this.render, this);

      this.initialize = __bind(this.initialize, this);
      return SignUpView.__super__.constructor.apply(this, arguments);
    }

    SignUpView.prototype.events = {
      "click #signup": "signup",
      "click #cancel": "cancel"
    };

    SignUpView.prototype.initialize = function() {
      return this.render();
    };

    SignUpView.prototype.render = function() {
      var template;
      template = $('#signup-template').html();
      $(this.el).html(template);
      $(this.el).dialog({
        title: "Sign up for Knitplot!",
        modal: true
      });
      $('#dialog-button-bar #cancel').button();
      return $('#dialog-button-bar #signup').button();
    };

    SignUpView.prototype.signup = function() {
      var _this = this;
      return Parse.User.signUp($('#email').val(), $('#password').val(), {
        email: $('#email').val()
      }, {
        success: function() {
          $(_this.el).remove();
          return new LoggedInView();
        },
        error: function(user, error) {
          return alert(error.message);
        }
      });
    };

    SignUpView.prototype.cancel = function() {
      return $(this.el).remove();
    };

    return SignUpView;

  })(Parse.View);

  ChartEditView = (function(_super) {

    __extends(ChartEditView, _super);

    function ChartEditView() {
      this.render = __bind(this.render, this);

      this.onChangeText = __bind(this.onChangeText, this);

      this.onChangeTitle = __bind(this.onChangeTitle, this);

      this.onKeyUpTitle = __bind(this.onKeyUpTitle, this);

      this.onSaveButton = __bind(this.onSaveButton, this);

      this.onSVGButton = __bind(this.onSVGButton, this);

      this.initialize = __bind(this.initialize, this);
      return ChartEditView.__super__.constructor.apply(this, arguments);
    }

    ChartEditView.prototype.events = {
      "submit form": "onSaveButton",
      "click #svg": "onSVGButton",
      "keyup input": "onKeyUpTitle"
    };

    ChartEditView.prototype.initialize = function() {
      this.parser = new ChartParser();
      this.model.on("change:text", this.onChangeText);
      return this.render();
    };

    ChartEditView.prototype.onSVGButton = function() {
      var svg, url;
      svg = $("#chart").html();
      url = "data:image/svg+xml," + encodeURIComponent(svg);
      new SVGPreviewView({
        url: url
      });
      return false;
    };

    ChartEditView.prototype.onSaveButton = function() {
      var attrs, options,
        _this = this;
      if (!Parse.User.current()) {
        new NeedToSignUpView();
        return false;
      }
      attrs = {
        creator: Parse.User.current(),
        title: this.$('#title').val(),
        text: this.$('#text').val()
      };
      options = {
        error: function() {
          return new ErrorView({
            message: "Unable to set title and text."
          });
        }
      };
      if (this.model.set(attrs, options)) {
        knitplot.saveChart();
      }
      return false;
    };

    ChartEditView.prototype.onKeyUpTitle = function() {
      var title,
        _this = this;
      title = this.$('#title').val();
      if (title !== (this.model.get('title') || "")) {
        return this.model.set({
          title: title
        }, {
          error: function() {
            return new ErrorView({
              message: "Unable to set title."
            });
          }
        });
      }
    };

    ChartEditView.prototype.onChangeTitle = function() {
      var title;
      title = this.model.get("title") || "";
      if (this.titleEdit.val() !== title) {
        return this.titleEdit.val(title);
      }
    };

    ChartEditView.prototype.onChangeText = function() {
      return this.parser.parse(this.model.get("text"));
    };

    ChartEditView.prototype.render = function() {
      var template;
      template = $("#chart-template").html();
      $(this.el).html(_.template(template)({
        model: this.model
      }));
      $("#app").html(this.el);
      $("#save").button();
      $("#svg").button();
      this.titleEdit = this.$("#title");
      this.onChangeTitle();
      new ChartGraphicView({
        el: this.$('#chart').get(0),
        model: this.model,
        parser: this.parser
      });
      new ChartTextView({
        el: $("#text").get(0),
        model: this.model,
        parser: this.parser
      });
      this.onChangeText();
      new ParseErrorsView({
        parser: this.parser
      });
      return this.delegateEvents();
    };

    return ChartEditView;

  })(Parse.View);

  ChartGraphicView = (function(_super) {

    __extends(ChartGraphicView, _super);

    function ChartGraphicView() {
      this.render = __bind(this.render, this);

      this.onCanvasMouseUp = __bind(this.onCanvasMouseUp, this);

      this.onCanvasMouseMove = __bind(this.onCanvasMouseMove, this);

      this.onCanvasMouseDown = __bind(this.onCanvasMouseDown, this);

      this.onChangeChart = __bind(this.onChangeChart, this);

      this.onChangeSelection = __bind(this.onChangeSelection, this);

      this.initialize = __bind(this.initialize, this);
      return ChartGraphicView.__super__.constructor.apply(this, arguments);
    }

    ChartGraphicView.prototype.initialize = function() {
      this.model = this.options.model;
      this.parser = this.options.parser;
      this.model.on("change:selection", this.onChangeSelection);
      this.parser.on("change:chart", this.onChangeChart);
      this.$el.on("mousedown", this.onCanvasMouseDown);
      this.$el.on("mousemove", this.onCanvasMouseMove);
      this.$el.on("mouseup", this.onCanvasMouseUp);
      this.canvas = new Raphael(this.el);
      return this.render();
    };

    ChartGraphicView.prototype.onChangeSelection = function() {
      return this.onChangeChart();
    };

    ChartGraphicView.prototype.onChangeChart = function() {
      var chart;
      chart = this.parser.get("chart");
      if (chart) {
        this.graphic = new Graphic(chart, this.canvas.width, this.canvas.height);
        return this.graphic.draw(this.canvas, this.model.get("selection"));
      }
    };

    ChartGraphicView.prototype.onCanvasMouseDown = function(event) {
      var x, y;
      x = event.pageX - this.$el.position().left;
      y = event.pageY - this.$el.position().top;
      this.mouseDownAction = this.graphic.actionAtPoint(x, y);
      if (!this.mouseDownAction) {
        return;
      }
      return this.model.set("selection", {
        start: {
          row: this.mouseDownAction.textRow,
          column: this.mouseDownAction.textColumn
        },
        end: {
          row: this.mouseDownAction.textRow,
          column: this.mouseDownAction.textColumn + this.mouseDownAction.textLength
        }
      });
    };

    ChartGraphicView.prototype.onCanvasMouseMove = function(event) {
      var action, endAction, startAction, x, y;
      if (!this.mouseDownAction) {
        return;
      }
      x = event.pageX - this.$el.position().left;
      y = event.pageY - this.$el.position().top;
      action = this.graphic.actionAtPoint(x, y);
      if (!action) {
        return;
      }
      if (this.mouseDownAction.textOffset < action.textOffset) {
        startAction = this.mouseDownAction;
        endAction = action;
      } else {
        startAction = action;
        endAction = this.mouseDownAction;
      }
      return this.model.set("selection", {
        start: {
          row: startAction.textRow,
          column: startAction.textColumn
        },
        end: {
          row: endAction.textRow,
          column: endAction.textColumn + endAction.textLength
        }
      });
    };

    ChartGraphicView.prototype.onCanvasMouseUp = function(event) {
      return delete this.mouseDownAction;
    };

    ChartGraphicView.prototype.render = function() {
      return this.onChangeChart();
    };

    return ChartGraphicView;

  })(Parse.View);

  ChartListView = (function(_super) {

    __extends(ChartListView, _super);

    function ChartListView() {
      this.render = __bind(this.render, this);

      this.onClickNew = __bind(this.onClickNew, this);

      this.initialize = __bind(this.initialize, this);
      return ChartListView.__super__.constructor.apply(this, arguments);
    }

    ChartListView.prototype.events = {
      "click #new": "onClickNew"
    };

    ChartListView.prototype.initialize = function() {
      this.start = this.options.start;
      return this.render();
    };

    ChartListView.prototype.onClickNew = function() {
      return knitplot.newChart();
    };

    ChartListView.prototype.render = function() {
      var template;
      template = $("#chart-list-template").html();
      $(this.el).html(_.template(template)({
        collection: this.collection.first(10),
        start: this.start,
        previous: this.start - 10,
        next: this.collection.size() > 10 ? this.start + 10 : 0
      }));
      $("#leftbar").html(this.el);
      $("#new").button();
      return this.delegateEvents();
    };

    return ChartListView;

  })(Parse.View);

  ParseErrorsView = (function(_super) {

    __extends(ParseErrorsView, _super);

    function ParseErrorsView() {
      this.onChangeErrors = __bind(this.onChangeErrors, this);

      this.initialize = __bind(this.initialize, this);
      return ParseErrorsView.__super__.constructor.apply(this, arguments);
    }

    ParseErrorsView.prototype.initialize = function() {
      this.$el = $("#errors");
      this.parser = this.options.parser;
      this.parser.on("change:errors", this.onChangeErrors);
      return this.onChangeErrors();
    };

    ParseErrorsView.prototype.onChangeErrors = function() {
      var lines,
        _this = this;
      if (this.parser.get("errors").length === 0) {
        return this.$el.hide();
      } else {
        lines = _.map(this.parser.errors, function(error) {
          return "Line " + error.line + ", Column " + error.column + ": " + error.message;
        });
        this.$el.html(lines.join("<br>"));
        return this.$el.show();
      }
    };

    return ParseErrorsView;

  })(Parse.View);

  ChartTextView = (function(_super) {

    __extends(ChartTextView, _super);

    function ChartTextView() {
      this.render = __bind(this.render, this);

      this.onChangeErrors = __bind(this.onChangeErrors, this);

      this.onChangeSelection = __bind(this.onChangeSelection, this);

      this.onChangeText = __bind(this.onChangeText, this);

      this.onEditText = __bind(this.onEditText, this);

      this.initialize = __bind(this.initialize, this);
      return ChartTextView.__super__.constructor.apply(this, arguments);
    }

    ChartTextView.prototype.initialize = function() {
      this.errorMarks = [];
      this.parser = this.options.parser;
      this.model.on("change:text", this.onChangeText);
      this.model.on("change:selection", this.onChangeSelection);
      this.parser.on("change:errors", this.onChangeErrors);
      return this.render();
    };

    ChartTextView.prototype.onEditText = function() {
      var text,
        _this = this;
      text = this.textArea.getValue() || "";
      if (text !== (this.model.get('text') || "")) {
        return this.model.set({
          text: text
        }, {
          error: function() {
            return new ErrorView({
              message: "Unable to set text."
            });
          }
        });
      }
    };

    ChartTextView.prototype.onChangeText = function() {
      var text;
      text = this.model.get("text") || "";
      if (this.textArea.getValue() !== text) {
        return this.textArea.setValue(text);
      }
    };

    ChartTextView.prototype.onChangeSelection = function() {
      var selection;
      selection = this.model.get("selection");
      if (!selection) {
        return;
      }
      return this.textArea.setSelection({
        line: selection.start.row,
        ch: selection.start.column
      }, {
        line: selection.end.row,
        ch: selection.end.column
      });
    };

    ChartTextView.prototype.onChangeErrors = function() {
      var _this = this;
      _.each(this.errorMarks, function(mark) {
        return mark.clear();
      });
      this.errorMarks = [];
      return _.each(this.parser.errors, function(error) {
        return _this.errorMarks.push(_this.textArea.markText({
          line: error.line - 1,
          ch: error.column - 1
        }, {
          line: error.line - 1,
          ch: (error.column + error.length) - 1
        }, {
          className: "error-mark"
        }));
      });
    };

    ChartTextView.prototype.render = function() {
      this.textArea = CodeMirror.fromTextArea(this.el, {
        theme: "solarized light"
      });
      this.textArea.on("change", this.onEditText);
      this.onChangeText();
      return this.onChangeErrors();
    };

    return ChartTextView;

  })(Parse.View);

  SVGPreviewView = (function(_super) {

    __extends(SVGPreviewView, _super);

    function SVGPreviewView() {
      this.okay = __bind(this.okay, this);

      this.render = __bind(this.render, this);

      this.initialize = __bind(this.initialize, this);
      return SVGPreviewView.__super__.constructor.apply(this, arguments);
    }

    SVGPreviewView.prototype.events = {
      "click #okay": "okay"
    };

    SVGPreviewView.prototype.initialize = function() {
      this.url = this.options.url;
      return this.render();
    };

    SVGPreviewView.prototype.render = function() {
      var template;
      template = $('#svg-preview-template').html();
      $(this.el).html(_.template(template)({
        url: this.url
      }));
      $(this.el).dialog({
        title: "SVG",
        modal: true,
        width: 640,
        height: 480,
        position: {
          my: "center",
          at: "center",
          of: window
        }
      });
      return $("#dialog-button-bar #okay").button();
    };

    SVGPreviewView.prototype.okay = function() {
      return $(this.el).remove();
    };

    return SVGPreviewView;

  })(Parse.View);

}).call(this);
